# Use Python 3.11 slim image as base
FROM python:3.11-slim

# Create non-root user for security
RUN useradd -m nonrootuser

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    git \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /home/nonrootuser/workspace

# Copy project files
COPY --chown=nonrootuser:nonrootuser model/ ./model/
COPY --chown=nonrootuser:nonrootuser prerender/ ./prerender/
COPY --chown=nonrootuser:nonrootuser configs/ ./configs/
COPY --chown=nonrootuser:nonrootuser *.py ./
COPY --chown=nonrootuser:nonrootuser requirements.txt ./

# Switch to non-root user
USER nonrootuser

# Install Python dependencies
RUN pip install --user --no-cache-dir -r requirements.txt

# Add local bin to PATH
ENV PATH="/home/nonrootuser/.local/bin:${PATH}"
ENV PYTHONPATH="/home/nonrootuser/workspace:${PYTHONPATH}"

# # Create data directories
# RUN mkdir -p original/data prerendered/data

# Command to keep container running for development
CMD ["sleep", "infinity"]
